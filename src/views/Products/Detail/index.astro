---
// src/views/Products/Detail/index.astro
import { t } from '../../../i18n/i18n';
import type { Locale } from '../../../i18n/i18n';
import './styles.css';
import { initProductDetail } from './scripts.js';
import CardQuiz from '../../../components/common/cardQuiz/index.astro';
import QuizModal from '../../../components/quiz/QuizModal.astro';



// Interfaces locales
interface ProductSize {
  value: string;
  image: string;
}

interface Stockist {
  id: string;
  name: string;
  icon: string;
  link: string;
}

interface Product {
  id: string;
  name: string;
  image: string;
  available?: string;
  background_image: string;
  background_color: string;
  header_text_color: string;
  color_button: string;
  sizes: ProductSize[];
  description?: string;
  short_description?: string;
  presentaciones?: Array<{
    value: string;
    icono: string;
  }>;
  // relatedProducts es opcional ya que no existe en la estructura actual
  relatedProducts?: string[];
  weight?: string[];
  nutrition?: any;
}

const { currentLang, productId } = Astro.props;

// Obtener datos desde traducciones
const productsAssets = t('home', { namespace: 'products', locale: currentLang }) || {};
const products = t('items', { namespace: 'products', locale: currentLang as Locale }) || [];
const stockists = t('stockist', { namespace: 'products', locale: currentLang as Locale }) || [];
const product = products.find((item: Product) => item.id === productId);
const brandsAssets = t('', { namespace: 'brands', locale: currentLang }) || {};
const newsAssets =  t('', { namespace: 'news', locale: currentLang }) || {};
const brandsList = brandsAssets.brands || [];
const zibasBrand = brandsList.find((brand: any) => brand.id === 'ranchitas');
const cardQuizAssets = t('cardQuiz', { namespace: 'common', locale: currentLang }) || {};
const zibasProducts = (zibasBrand?.products || []).filter((product: any) => product.id !== productId);

// Si el producto no existe, lanzar error
if (!product || Object.keys(product).length === 0) {
  throw new Error(t('errors.product_not_found', { locale: currentLang }));
}

// Asegurar que todas las propiedades necesarias existan
const safeProduct: Product = {
  id: product.id || '',
  name: product.name || '',
  image: product.image || '',
  background_image: product.background_color || '',
  background_color: product.background_color || '',
  header_text_color: product.header_text_color || '#000000',
  color_button: product.color_button || '#000000',
  sizes: Array.isArray(product.sizes) ? product.sizes : [],
  available: product.available || '',
  description: product.description || '',
  weight: Array.isArray(product.weight) ? product.weight : [],
  nutrition: product.nutrition,
};

// Verificar si el producto tiene información nutricional
const hasNutrition = safeProduct.nutrition && 
  (Array.isArray(safeProduct.nutrition) ? safeProduct.nutrition.length > 0 : Object.keys(safeProduct.nutrition).length > 0);

// Obtener todos los productos como un array
const productsData = t('items', { locale: currentLang, namespace: 'products' }) || [];
const allProductsArray = Array.isArray(productsData) ? productsData : [];

// Filtrar productos relacionados - simplificado para evitar errores
let relatedProducts: any[] = [];
// Solo usar productos de la misma categoría si hay más de 1 producto
if (allProductsArray.length > 1) {
  relatedProducts = allProductsArray
    .filter((p: any) => p.id !== productId);
}

---

{safeProduct.background_color && (
  <article
    id="product-detail"
    class="product-detail pt-12 md:pt-29 pb-32 bg-cover bg-center relative bg-primaryCream"
    transition:animate="slide"
  >
    <div class="md:mt-[0] container mx-auto px-6 py-5 flex flex-col xl:flex-row gap-24">
      <div class="relative flex justify-center items-center w-full xl:w-[605px] p-4 xl:px-28 xl:py-8 rounded-[30px] gap-2 cursor-pointer overflow-hidden group bg-white xl:h-[593px] md:h-[593px] lg:h-[593px] h-[450px]">
        <div class="absolute inset-0 bg-black bg-opacity-0  transition-all duration-300 rounded-[85px]"></div>
        <img id="product-image" 
          class="relative z-10 xl:max-w-full xl:h-auto lg:max-w-[400px] md:max-w-[400px]" 
            src={safeProduct.image} alt={safeProduct.name} 
            transition:name={`product-image-${safeProduct.id}`} />
      </div>
      
      {/* Contenido del lado derecho */}
      <div class="w-full xl:w-1/2  h-auto">
        <h1 
          class="font-title  text-[18px] font-medium py-4 text-[#F86509]"
        >
         {currentLang === 'es' ? 'Sabor Intenso' : 'Intense flavor'}
        </h1>
        <div class="flex justify-between items-center mb-8">
          <h1 class="lg:text-6xl text-6xl font-bold italic">{safeProduct.name}</h1>
        </div>
        <h1 
          class="font-title text-[24px] font-medium py-0"
        >
          {currentLang === 'es' ? 'Tamaños disponibles:' : 'Available sizes:'}
        </h1>
        {safeProduct.weight && safeProduct.weight.length > 0 && (
          <div class="my-4 max-w-full">
            <div class="grid grid-cols-2 gap-2 md:grid-cols-6 lg:grid-cols-5 xl:grid-cols-5">
              {safeProduct.weight.map((weight, index) => (
                <div class="w-full min-w-0">
                  <button 
                    class="weight-option block w-[90.7px] h-[52px] px-4 lg:px-5 text-center rounded-[50px] border-2 border-[#F86509] text-base md:text-xl font-bold bg-white hover:bg-[#F86509] hover:text-white cursor-pointer transition-all duration-300"
                    data-weight={weight}
                    data-index={index}
                  >
                    {weight}
                  </button>
                </div>
              ))}
            </div>
          </div>
        )}
        <div class="w-full h-[58px] bg-white rounded-[15px] p-1 flex gap-1 my-8" id="product-tabs">
          <button 
            class="tab-button flex-1 h-[49px] rounded-[12px] flex items-center justify-center px-2 transition-all duration-300"
            data-tab="description"
          >
            <span class="text-[16px] font-medium leading-6">
              {currentLang === 'es' ? 'Descripción General' : 'General Description'}
            </span>
          </button>
          
          {hasNutrition && (
            <button 
              class="tab-button flex-1 h-[49px] rounded-[12px] flex items-center justify-center px-2 transition-all duration-300"
              data-tab="nutrition"
            >
              <span class="text-[16px] font-medium leading-6">
                {currentLang === 'es' ? 'Tabla de Nutrición' : 'Nutrition Table'}
              </span>
            </button>
          )}
        </div>

        <div class="bg-white rounded-[20px] w-full">
          <p class="text-black pt-[33px] pb-[33px] pl-[33px] pr-[33px]">{safeProduct.description}</p>
        </div>

        <button
          type="button"
          id="where-to-buy-open"
          class="bg-[#D61F2C] text-white rounded-[50px] w-full h-[52px] mt-[20px] text-start pl-[20px]"
        >
          {currentLang === 'es' ? '¿Dónde comprar?' : 'Where buy?'}
        </button>
      </div>
    </div>

    <div class="hidden  xl:block absolute bottom-0 top-[809px] right-0 pointer-events-none z-20">
          <svg width="427" height="375" viewBox="0 0 427 375" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M427 0L427 374.5C416.5 322 394 261 364 243C334 225 329 219.5 312.5 209.5C285.26 188.395 254 143 239 105.5C224 68 218.5 65 205 55.5C191.5 46 94.8911 48.0193 0 0L427 0Z" fill="#FAF0D5"/>
          </svg>
    </div>
    {/* Sección de Productos Relacionados */}

  </article>

  <!-- Where to buy modal -->
  <div
    id="where-to-buy-modal"
    class="fixed inset-0 z-[2147483646] hidden"
    aria-hidden="true"
  >
    <div class="absolute inset-0 bg-black/60" data-wtb-backdrop></div>

    <div class="absolute inset-0 flex items-center justify-center p-4 sm:p-6">
      <div class="w-full max-w-3xl bg-white rounded-[28px] shadow-2xl overflow-hidden">
        <div class="flex items-center justify-between px-6 py-5 border-b border-black/10">
          <h3 class="font-title text-2xl md:text-3xl font-bold italic text-black">
            {currentLang === 'es' ? 'Compra en delivery' : 'Order for delivery'}
          </h3>
          <button
            type="button"
            class="w-10 h-10 rounded-full bg-primaryCream text-black flex items-center justify-center hover:opacity-80 transition"
            aria-label={currentLang === 'es' ? 'Cerrar' : 'Close'}
            data-wtb-close
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 6 6 18" />
              <path d="M6 6 18 18" />
            </svg>
          </button>
        </div>

        <div class="p-6 sm:p-8">
          {Array.isArray(stockists) && stockists.length > 0 ? (
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 sm:gap-6">
              {stockists.map((s: Stockist) => (
                <a
                  href={s.link}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="group rounded-2xl bg-primaryCream p-4 sm:p-5 flex flex-col items-center justify-center text-center hover:opacity-90 transition"
                >
                  <div class="bg-white rounded-2xl w-full flex items-center justify-center p-4 sm:p-5">
                    <img
                      src={s.icon}
                      alt={s.name}
                      class="h-14 sm:h-16 w-auto object-contain"
                      loading="lazy"
                    />
                  </div>
                  <div class="mt-3 font-bold text-black text-sm sm:text-base">{s.name}</div>
                </a>
              ))}
            </div>
          ) : (
            <div class="text-center text-black/70">
              {currentLang === 'es'
                ? 'No hay opciones de delivery disponibles por el momento.'
                : 'No delivery options are available at the moment.'}
            </div>
          )}
        </div>
      </div>
    </div>
  </div>

  <section class="z-30 mb-32 mt-8">
    <div class="container mx-auto px-6">
      {/* Título y subtítulo */}
      <div class="mb-12">
        <h2 class="text-5xl md:text-6xl font-bold italic mb-4">
          {currentLang === 'es' ? 'Sabores que te encantarán' : 'Flavors you will love'}
        </h2>
        <p class="text-xl md:text-2xl italic">
          {currentLang === 'es' ? 'Descubre otros sabores que también te encantarán' : 'Discover other flavors that you will also love'}
        </p>
      </div>
      
      {/* Carousel de productos */}
      <div class="relative">
        {relatedProducts.length > 0 ? (
          <>
            <div class="swiper related-products-swiper">
              <div class="swiper-wrapper">
                {relatedProducts.map((product: any) => (
                  <div class="swiper-slide h-auto">
                    <a 
                      href={`/${currentLang}/productos/${product.id}`}
                      class="h-full rounded-[30px] p-8 flex flex-col items-center justify-between transition-transform duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#F86509]"
                      style={{ backgroundColor: product.background_color }}
                    >
                      {/* Imagen del producto */}
                      <div class="w-full flex justify-center items-center flex-1 mb-6">
                        <img 
                          src={product.image} 
                          alt={product.name}
                          class="max-w-[408px] h-[235px] object-contain"
                        />
                      </div>
                      {/* Información del producto */}
                      <div class="w-full text-start">
                        <h3 
                          class="text-3xl font-bold mb-2"
                          style={{ color: product.text_color }}
                        >
                          {product.name}
                        </h3>
                        <p 
                          class="text-lg italic mb-2"
                          style={{ color: product.text_color }}
                        >
                          {product.short_description}
                        </p>
                      </div>
                    </a>
                  </div>
                ))}
              </div>
              <div class="swiper-pagination-products mt-6"></div>
            </div>

            {/* Navigation Arrows */}
            {relatedProducts.length > 0 && (
              <>
                <button class="swiper-button-prev-products absolute left-0 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-white shadow-lg flex items-center justify-center text-[#F86509] hover:bg-[#F86509] hover:text-white transition-colors z-10">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                  </svg>
                </button>
                <button class="swiper-button-next-products absolute right-0 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-white shadow-lg flex items-center justify-center text-[#F86509] hover:bg-[#F86509] hover:text-white transition-colors z-10">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                  </svg>
                </button>
              </>
            )}
          </>
        ) : (
          <div class="text-center py-12">
            <p class="text-xl text-gray-600">
              {currentLang === 'es' ? 'No hay productos relacionados disponibles' : 'No related products available'}
            </p>
          </div>
        )}
      </div>
    </div>
  </section>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <script is:inline src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

  <script is:inline>
    (function () {
      function initRelatedProductsSwiper() {
        const root = document.querySelector('.related-products-swiper');
        if (!(root instanceof HTMLElement)) return;

        if (typeof Swiper === 'undefined') {
          setTimeout(initRelatedProductsSwiper, 50);
          return;
        }

        const hasSlides = root.querySelector('.swiper-slide');
        if (!hasSlides) return;

        try {
          const existing = root['swiper'];
          if (existing) {
            existing.destroy(true, true);
          }

          const slideCount = root.querySelectorAll('.swiper-slide').length;
          const shouldLoop = slideCount > 3;

          const swiper = new Swiper(root, {
            slidesPerView: 1.15,
            spaceBetween: 20,
            centeredSlides: true,
            loop: shouldLoop,
            watchOverflow: true,
            autoplay: {
              delay: 4000,
              disableOnInteraction: false,
              pauseOnMouseEnter: true,
            },
            navigation: {
              nextEl: '.swiper-button-next-products',
              prevEl: '.swiper-button-prev-products',
            },
            pagination: {
              el: '.swiper-pagination-products',
              clickable: true,
            },
            breakpoints: {
              640: {
                slidesPerView: 1.3,
                spaceBetween: 24,
                centeredSlides: true,
              },
              768: {
                slidesPerView: 2.2,
                spaceBetween: 28,
                centeredSlides: true,
              },
              1024: {
                slidesPerView: 3.2,
                spaceBetween: 32,
                centeredSlides: true,
              },
            },
          });

          setTimeout(() => swiper.update(), 50);
        } catch (e) {
          console.error(e);
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initRelatedProductsSwiper);
      } else {
        initRelatedProductsSwiper();
      }

      document.addEventListener('astro:page-load', initRelatedProductsSwiper);
    })();
  </script>
  <div class="relative z-30">
    <CardQuiz 
      cardQuiz={cardQuizAssets}
    />
  </div>

  <QuizModal currentLang={currentLang} />
)}

<script>
  import { initProductDetail } from './scripts.js';
  
  document.addEventListener('astro:page-load', () => {
    // Inicializar producto
    initProductDetail();
    
    // Weight options
    const weightOptions = document.querySelectorAll<HTMLButtonElement>('.weight-option');
    weightOptions.forEach(option => {
      option.addEventListener('click', () => {
        weightOptions.forEach(opt => {
          opt.classList.remove('bg-[#F86509]', 'text-white');
          opt.classList.add('bg-white');
        });
        option.classList.add('bg-[#F86509]', 'text-white');
        option.classList.remove('bg-white');
        console.log('Peso seleccionado:', option.dataset.weight);
      });
    });
    weightOptions[0]?.click();
    
    // Tabs
    const tabs = document.querySelectorAll('.tab-button');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => {
          t.classList.remove('bg-[#F86509]');
          t.querySelector('span')?.classList.remove('text-white');
          t.querySelector('span')?.classList.add('text-[#0A0A0A]');
        });
        tab.classList.add('bg-[#F86509]');
        tab.querySelector('span')?.classList.add('text-white');
        tab.querySelector('span')?.classList.remove('text-[#0A0A0A]');
      });
    });
    (tabs[0] as HTMLElement)?.click();
  });
</script>

<script is:inline>
  (function () {
    function initWhereToBuyModal() {
      const openBtn = document.getElementById('where-to-buy-open');
      const modal = document.getElementById('where-to-buy-modal');
      if (!(openBtn instanceof HTMLButtonElement)) return;
      if (!(modal instanceof HTMLElement)) return;

      if (modal.dataset.wtbInit === '1') return;
      modal.dataset.wtbInit = '1';

      const closeBtn = modal.querySelector('[data-wtb-close]');
      const backdrop = modal.querySelector('[data-wtb-backdrop]');

      const open = () => {
        modal.classList.remove('hidden');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
      };

      const close = () => {
        modal.classList.add('hidden');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      };

      openBtn.addEventListener('click', open);

      if (closeBtn) closeBtn.addEventListener('click', close);
      if (backdrop) backdrop.addEventListener('click', close);

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') close();
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initWhereToBuyModal);
    } else {
      initWhereToBuyModal();
    }

    document.addEventListener('astro:page-load', initWhereToBuyModal);
  })();
</script>
