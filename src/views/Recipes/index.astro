---
// src/views/Recipes/index.astro
import { getLocale } from '../../i18n/i18n';
import './styles.css';
import RecipeCard from '../../components/recipes/RecipeCard.astro';

interface Recipe {
  id: string;
  title: string;
  image?: string;
  preparation_time: number;
  type?: string;
  category?: string;
  product?: string | string[];
  difficulty?: string;
}

const currentLang = getLocale();

// Get all recipe files with correct Vite glob typing
const recipeModules = import.meta.glob<{default: Recipe}>('../../locales/*/recipes/*.json');
const allRecipes: Recipe[] = [];

// Process each file
for (const path in recipeModules) {
  const lang = path.split('/')[3];
  if (lang === currentLang) {
    const module = await recipeModules[path]();
    allRecipes.push(module.default);
  }
}

// Shared translations
const noRecipesText = currentLang === 'es' 
  ? 'No hay recetas disponibles en este momento.' 
  : 'No recipes available at this time.';
const noFilterResultsText = currentLang === 'es'
  ? 'No se encontraron resultados para la selección'
  : 'No results found for the selection';

// Hero texts
const heroTitle = currentLang === 'es' ? 'Smores with Yummi Pops Nacho and Sea Salt' : 'Smores with Yummi Pops Nacho and Sea Salt';
const heroDescription = currentLang === 'es' 
  ? 'Lorem ipsum dolor sit amet, consectetur adipiscing elit.'
  : 'Lorem ipsum dolor sit amet, consectetur adipiscing elit.';
const heroButton = currentLang === 'es' ? 'Ver ahora' : 'View now';

// Section title
const sectionTitle = currentLang === 'es' ? 'Descubre nuestras recetas' : 'Discover our recipes';

// Search and filter labels
const searchPlaceholder = currentLang === 'es' ? 'Encuentra tu receta favorita' : 'Find your favorite recipe';
const lineLabel = currentLang === 'es' ? 'Línea Yummi Pops' : 'Yummi Pops Line';
const categoryLabel = currentLang === 'es' ? 'Categorías' : 'Categories';
const personalizeButton = currentLang === 'es' ? 'Personalizar' : 'Customize';

// Filter options
const filterLabels = currentLang === 'es'
  ? { 
      all: 'Todos',
      breakfast: 'Desayuno', 
      brunch: 'Brunch',
      lunch: 'Almuerzo',
      dinner: 'Cena',
      snack: 'Snack'
    }
  : {
      all: 'All',
      breakfast: 'Breakfast',
      brunch: 'Brunch',
      lunch: 'Lunch',
      dinner: 'Dinner',
      snack: 'Snack'
    };

// Normaliza la categoría de receta
function normalizeType(r: Recipe): string {
  const rawCategory = String((r as any).category || '').toLowerCase().trim();
  const categoryMap: Record<string, string> = {
    'breakfast': 'breakfast',
    'brunch': 'brunch', 
    'lunch': 'lunch',
    'dinner': 'dinner',
    'snack': 'snack'
  };
  return categoryMap[rawCategory] || 'other';
}

// Obtener categorías únicas disponibles
const uniqueCategories = [...new Set(allRecipes.map(r => normalizeType(r)).filter(cat => cat !== 'other'))];

// Cargar catálogo de productos
interface ProductItem { id: string; name: string; description?: string; }
const productModules = import.meta.glob<{ default: { items: ProductItem[] } }>('../../locales/*/products.json');
const productMap: Record<string, ProductItem> = {};

for (const path in productModules) {
  const lang = path.split('/')[3];
  if (lang === currentLang) {
    const mod = await productModules[path]();
    for (const item of (mod.default.items || [])) {
      productMap[item.id] = item;
    }
  }
}

const uniqueProducts = Object.keys(productMap);

// Obtener receta destacada (primera)
const featuredRecipe = allRecipes[0];
---

<!-- Hero Section -->
<section class="relative bg-[#2392D3] to-blue-500 rounded-[30px] md:rounded-[40px] mx-4 md:mx-8 mt-8 mb-12 overflow-hidden">
  <div class="container mx-auto px-6 md:px-12 py-12 md:py-16 lg:py-20">
    {featuredRecipe && (
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
        <div class="nacho-pattern" style="background-image: url('/images/es/bg-product.png');"></div>
        <!-- Lado Izquierdo - Imagen -->
        <div class="relative rounded-3xl overflow-hidden z-40">
          <img
            src={featuredRecipe.image || '/images/recipes/placeholder.jpg'}
            alt={featuredRecipe.title}
            class="w-full h-[300px] md:h-[400px] object-cover rounded-3xl"
          />
        </div>

        <!-- Lado Derecho - Contenido -->
        <div class="text-white space-y-6">
          <h1 class="text-3xl md:text-4xl lg:text-5xl font-black leading-tight">
            {featuredRecipe.title}
          </h1>
          <p class="text-base md:text-lg">
            {heroDescription}
          </p>
          
          <a 
            href={`/${currentLang}/${currentLang === 'es' ? 'recetas' : 'recipes'}/${featuredRecipe.id}`}
            class="inline-block bg-white text-blue-600 font-bold px-8 py-3 rounded-full hover:bg-gray-100 transition-all transform hover:scale-105 shadow-lg"
          >
            {heroButton}
          </a>
        </div>

      </div>
    )}
  </div>

  <!-- Decorative circles -->
  <div class="absolute top-10 right-20 w-64 h-64 bg-white/10 rounded-full blur-3xl pointer-events-none"></div>
  <div class="absolute bottom-10 left-20 w-80 h-80 bg-blue-600/20 rounded-full blur-3xl pointer-events-none"></div>
</section>

<!-- Main Content -->
<div class="bg-white pb-16">
  <div class="container mx-auto px-4 md:px-8">

    <!-- Section Title -->
    <h2 class="text-4xl md:text-5xl font-black text-gray-900 mb-8">
      {sectionTitle}
    </h2>

    <!-- Search and Filters -->
    <div class="flex flex-col md:flex-row gap-4 mb-12">
      
      <!-- Search Input -->
      <div class="relative flex-1">
        <input 
          type="text"
          id="searchInput"
          placeholder={searchPlaceholder}
          class="w-full px-6 py-3 rounded-full border-2 border-gray-200 focus:border-orange focus:outline-none transition-colors"
        />
        <svg class="absolute right-6 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
      </div>

      <!-- Product Line Filter -->
      <div class="relative">
        <select 
          id="productFilter" 
          class="appearance-none bg-white rounded-full px-6 py-3 pr-10 text-base font-medium border-2 border-gray-200 cursor-pointer hover:border-gray-300 transition-colors focus:outline-none focus:border-orange min-w-[200px]"
        >
          <option value="all">{lineLabel}</option>
          {uniqueProducts.map(productId => (
            <option value={productId}>{productMap[productId]?.name || productId}</option>
          ))}
        </select>
        <svg class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 pointer-events-none text-gray-600" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
      </div>

      <!-- Category Filter -->
      <div class="relative">
        <select 
          id="typeFilter" 
          class="appearance-none bg-white rounded-full px-6 py-3 pr-10 text-base font-medium border-2 border-gray-200 cursor-pointer hover:border-gray-300 transition-colors focus:outline-none focus:border-orange min-w-[200px]"
        >
          <option value="all">{categoryLabel}</option>
          {uniqueCategories.includes('breakfast') && <option value="breakfast">{filterLabels.breakfast}</option>}
          {uniqueCategories.includes('brunch') && <option value="brunch">{filterLabels.brunch}</option>}
          {uniqueCategories.includes('lunch') && <option value="lunch">{filterLabels.lunch}</option>}
          {uniqueCategories.includes('dinner') && <option value="dinner">{filterLabels.dinner}</option>}
          {uniqueCategories.includes('snack') && <option value="snack">{filterLabels.snack}</option>}
        </select>
        <svg class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 pointer-events-none text-gray-600" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
      </div>

      <!-- Personalize Button -->
      <button 
        class="hidden md:flex items-center gap-2 bg-white rounded-full px-6 py-3 border-2 border-gray-200 font-medium hover:border-gray-300 transition-colors"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
        </svg>
        {personalizeButton}
      </button>
    </div>

    <!-- Recipes Grid -->
    {allRecipes.length === 0 ? (
      <p class="text-center text-gray-500 py-12">{noRecipesText}</p>
    ) : (
      <>
        <div id="recipesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
          {allRecipes.map((recipe: Recipe) => (
            <div 
              class="recipe-card" 
              data-type={normalizeType(recipe)}
              data-products={(Array.isArray(recipe.product) ? recipe.product : (recipe.product ? [recipe.product] : [])).join(',')}
              data-title={recipe.title.toLowerCase()}
            >
              <RecipeCard
                image={recipe.image || '/images/recipes/placeholder.jpg'}
                title={recipe.title}
                time={`${recipe.preparation_time}MIN`}
                id={recipe.id}
                difficulty={recipe.difficulty || (currentLang === 'es' ? 'Fácil' : 'Easy')}
                product={Array.isArray(recipe.product) ? recipe.product[0] : recipe.product}
              />
            </div>
          ))}
        </div>

        <!-- No results message -->
        <div id="noResults" class="hidden mt-12 flex items-center justify-center h-48">
          <p class="text-gray-500 text-lg font-medium">{noFilterResultsText}</p>
        </div>

        <!-- Pagination -->
        <div class="flex justify-center items-center gap-2 mt-12">
          <button class="w-10 h-10 rounded-full bg-[#F9A825] text-white font-bold flex items-center justify-center hover:bg-[#F57C00] transition-colors">
            1
          </button>
          <button class="w-10 h-10 rounded-full bg-gray-200 text-gray-700 font-bold flex items-center justify-center hover:bg-gray-300 transition-colors">
            2
          </button>
          <button class="w-10 h-10 rounded-full bg-gray-200 text-gray-700 font-bold flex items-center justify-center hover:bg-gray-300 transition-colors">
            3
          </button>
          <button class="w-10 h-10 rounded-full bg-[#F9A825] text-white font-bold flex items-center justify-center hover:bg-[#F57C00] transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </button>
        </div>
      </>
    )}
  </div>
</div>

<style>
  .nacho-pattern {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0.50;
    pointer-events: none;
    z-index: 1;
    background-repeat: repeat;
    background-size: 700px auto;
    background-position: center;
  }
</style>

<!-- Serialized product map -->
<script type="application/json" id="product-map">{JSON.stringify(productMap)}</script>

<script is:inline>
  (function() {
    'use strict';
    
    let PRODUCT_MAP = {};
    try {
      const mapEl = document.getElementById('product-map');
      if (mapEl && mapEl.textContent) {
        PRODUCT_MAP = JSON.parse(mapEl.textContent);
      }
    } catch(e) {
      console.error('Error parsing product map:', e);
    }

    function applyFilters() {
      const searchInput = document.getElementById('searchInput');
      const typeFilter = document.getElementById('typeFilter');
      const productFilter = document.getElementById('productFilter');
      const recipesGrid = document.getElementById('recipesGrid');
      const noResults = document.getElementById('noResults');
      
      if (!typeFilter || !productFilter || !searchInput) {
        console.warn('Filters not found, retrying...');
        return;
      }

      const searchValue = searchInput.value.toLowerCase().trim();
      const typeValue = typeFilter.value || 'all';
      const productValue = productFilter.value || 'all';

      const recipeCards = document.querySelectorAll('.recipe-card');
      let visibleCount = 0;

      recipeCards.forEach(function(card) {
        const cardType = card.getAttribute('data-type') || '';
        const cardProductsStr = card.getAttribute('data-products') || '';
        const cardTitle = card.getAttribute('data-title') || '';
        const cardProducts = cardProductsStr.split(',').filter(function(p) { return p.trim() !== ''; });

        const matchesSearch = searchValue === '' || cardTitle.includes(searchValue);
        const matchesType = typeValue === 'all' || cardType === typeValue;
        const matchesProduct = productValue === 'all' || cardProducts.indexOf(productValue) !== -1;
        const isVisible = matchesSearch && matchesType && matchesProduct;

        card.style.display = isVisible ? '' : 'none';
        if (isVisible) visibleCount++;
      });

      const hasResults = visibleCount > 0;
      
      if (recipesGrid) {
        recipesGrid.style.display = hasResults ? '' : 'none';
      }
      
      if (noResults) {
        if (hasResults) {
          noResults.classList.add('hidden');
          noResults.classList.remove('flex');
        } else {
          noResults.classList.remove('hidden');
          noResults.classList.add('flex');
        }
      }
    }

    function attachListeners() {
      const searchInput = document.getElementById('searchInput');
      const typeFilter = document.getElementById('typeFilter');
      const productFilter = document.getElementById('productFilter');
      
      if (searchInput) {
        searchInput.addEventListener('input', applyFilters);
      }
      if (typeFilter) {
        typeFilter.addEventListener('change', applyFilters);
      }
      if (productFilter) {
        productFilter.addEventListener('change', applyFilters);
      }
    }

    function init() {
      attachListeners();
      applyFilters();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
    
    window.addEventListener('load', applyFilters);
    document.addEventListener('astro:page-load', init);
  })();
</script>

<style>
  select, input {
    background-image: none;
  }
</style>