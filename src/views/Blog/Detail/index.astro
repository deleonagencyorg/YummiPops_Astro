---
import { type Locale } from '../../../i18n/i18n';
import Breadcrumb from '../../../components/common/Breadcrumb/Breadcrumb.astro';
import BlogDetailSkeleton from '../../../components/blog/BlogDetailSkeleton.astro';
import { fade, slide } from 'astro:transitions';
import LazyImage from '../../../components/common/LazyImage.astro';
import MainLayout from '../../../layouts/MainLayout.astro';
import { ViewTransitions } from 'astro:transitions';
import './styles.css';

interface Props {
  blogPost: {
    id: string;
    slug: string;
    title: string;
    content: string;
    image: string;
    author: string;
    published_date: string;
  };
  currentLang: Locale;
  allBlogPosts?: Array<{
    id: string;
    slug: string;
    title: string;
    summary: string;
    image: string;
    published_date: string;
  }>;
  isLoading?: boolean;
}

const { blogPost, currentLang, allBlogPosts = [], isLoading = false } = Astro.props;

// Filter out the current blog post and get the 3 most recent posts
const suggestedPosts = allBlogPosts
  .filter(post => post.id !== blogPost.id)
  .slice(0, 3);

// Get the appropriate title based on language
const readMoreTitle = currentLang === 'es' ? 'También te puede interesar' : 'You may also be interested';

const shareText = currentLang === 'es' ? 'Compartir:' : 'Share:';

const backToNewsText = currentLang === 'es' ? 'Volver a noticias' : 'Back to news';
const backToNewsHref = `/${currentLang}/blog`;
---

<MainLayout title={blogPost.title} description={blogPost.summary} class="bg-primaryCream">
  <ViewTransitions />
  <div class="container ">
    <div class="ml-[40px] mt-[40px] mr-[40px] mb-20">
    {isLoading ? (
      <BlogDetailSkeleton />
    ) : (
      <>
        <Breadcrumb bgColor="bg-transparent" textColor="text-black" hoverColor="hover:text-black" />

        <div class="mt-4">
          <a href={backToNewsHref} class="inline-flex items-center gap-2 text-orange font-bold hover:opacity-80 transition">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M15 18l-6-6 6-6" />
            </svg>
            {backToNewsText}
          </a>
        </div>

        <!-- Hero Section with Image -->
        <div class="mt-6 relative rounded-[32px] overflow-hidden" style="height: 420px;" transition:animate={slide({ duration: '0.3s' })}>
          <LazyImage
            src={blogPost.image}
            alt={blogPost.title}
            class="w-full h-full object-cover"
            loading="eager"
          />
          <div class="absolute top-6 left-6">
            <span class="inline-flex items-center px-5 py-2 rounded-full bg-orange text-white font-bold text-sm shadow">
              {currentLang === 'es' ? 'Producto' : 'Product'}
            </span>
          </div>
        </div>

        <div class="mt-8 grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
          <!-- Main Card -->
          <div class="lg:col-span-8">
            <div class="bg-white rounded-[32px] shadow-[0_20px_50px_rgba(0,0,0,0.12)] overflow-hidden">
              <div class="p-8 md:p-10">
                <div class="text-sm text-gray-500 flex items-center gap-3 mb-4">
                  {blogPost.published_date && <span>{blogPost.published_date}</span>}
                  {blogPost.published_date && blogPost.author && <span>•</span>}
                  {blogPost.author && <span>{blogPost.author}</span>}
                </div>

                <h1 class="font-title text-3xl md:text-5xl font-bold italic text-black" transition:name={`blog-title-${blogPost.id}`}>
                  {blogPost.title}
                </h1>

                <!-- Share Section (pill buttons) -->
                <div class="mt-8">
                  <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                    <span class="text-sm text-gray-700 font-bold shrink-0">{shareText}</span>
                    <div class="flex flex-wrap gap-3">
                      <a
                        href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(Astro.url.href)}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="inline-flex items-center gap-2 px-5 py-2 rounded-full bg-primaryCream text-black font-bold text-sm hover:opacity-80 transition"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M22 12a10 10 0 1 0-11.5 9.9v-7h-2.1V12h2.1V9.8c0-2.1 1.2-3.3 3.1-3.3.9 0 1.9.2 1.9.2v2.1h-1.1c-1.1 0-1.4.7-1.4 1.4V12h2.4l-.4 2.9h-2v7A10 10 0 0 0 22 12Z"/>
                        </svg>
                        Facebook
                      </a>

                      <a
                        href={`https://twitter.com/intent/tweet?url=${encodeURIComponent(Astro.url.href)}&text=${encodeURIComponent(blogPost.title)}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="inline-flex items-center gap-2 px-5 py-2 rounded-full bg-primaryCream text-black font-bold text-sm hover:opacity-80 transition"
                      >
                        <span class="font-black">X</span>
                      </a>

                      <a
                        href={`mailto:?subject=${encodeURIComponent(blogPost.title)}&body=${encodeURIComponent(Astro.url.href)}`}
                        class="inline-flex items-center gap-2 px-5 py-2 rounded-full bg-primaryCream text-black font-bold text-sm hover:opacity-80 transition"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <rect width="20" height="16" x="2" y="4" rx="2"/>
                          <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
                        </svg>
                        Email
                      </a>

                      <button
                        type="button"
                        class="inline-flex items-center gap-2 px-5 py-2 rounded-full bg-primaryCream text-black font-bold text-sm hover:opacity-80 transition"
                        onclick={`navigator.clipboard.writeText('${Astro.url.href}'); alert('${currentLang === 'es' ? 'Enlace copiado' : 'Link copied'}');`}
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                          <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                        </svg>
                        {currentLang === 'es' ? 'Copiar' : 'Copy'}
                      </button>
                    </div>
                  </div>
                </div>

                <div class="mt-8 border-t border-orange/20"></div>

                <div class="mt-8 news-detail blog-content prose prose-lg max-w-none text-black" transition:animate={fade({ duration: '0.5s' })}>
                  <Fragment set:html={blogPost.content} />
                </div>
              </div>
            </div>
          </div>

          <!-- Sidebar -->
          {suggestedPosts.length > 0 && (
            <aside class="lg:col-span-4">
              <div class="bg-white rounded-[32px] shadow-[0_20px_50px_rgba(0,0,0,0.12)] p-6 md:p-8">
                <h2 class="text-black font-title text-2xl md:text-3xl font-bold italic mb-6">{readMoreTitle}</h2>
                <div class="flex flex-col gap-6">
                  {suggestedPosts.map((post) => (
                    <a href={`/${currentLang}/blog/${post.slug || post.id}`} class="block hover:opacity-90 transition">
                      <div class="relative rounded-2xl overflow-hidden">
                        <LazyImage
                          src={post.image}
                          alt={post.title}
                          class="w-full h-44 object-cover"
                          loading="lazy"
                        />
                      </div>
                      <div class="mt-3">
                        <div class="text-xs text-gray-500 mb-2">{post.published_date || ''}</div>
                        <div class="text-black font-bold leading-snug">{post.title}</div>
                      </div>
                    </a>
                  ))}
                </div>
              </div>
            </aside>
          )}
        </div>
      </>
    )}
  </div>
</MainLayout>

